<!DOCTYPE html>
<html>


<head>
  <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE"/>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

  <link rel=stylesheet href="platform.css" type="text/css">
<link rel=stylesheet href="libs/dateField/jquery.dateField.css" type="text/css">

<link rel=stylesheet href="gantt.css" type="text/css">
<link rel=stylesheet href="print.css" type="text/css" media="print">

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>

<script src="libs/jquery.livequery.min.js"></script>
<script src="libs/jquery.timers.js"></script>
<script src="libs/platform.js"></script>
<script src="libs/date.js"></script>
<script src="libs/i18nJs.js"></script>
<script src="libs/dateField/jquery.dateField.js"></script>
<script src="libs/JST/jquery.JST.js"></script>

<script src="ganttUtilities.js"></script>

<link rel="stylesheet" type="text/css" href="libs/jquery.svg.css">
<script type="text/javascript" src="libs/jquery.svg.js"></script>
<script type="text/javascript" src="libs/jquery.svgdom.1.8.js"></script>
</head>
<body>

<style>
  .draggable {
    cursor: move;
  }

  .taskStatus {
    height: 100%;
  }

  .taskProgress {
    height: 100%;
  }

  .taskLabel {
    height: 100%;
  }

  .ui-resizable-handle {
    background-color: red;
  }

</style>

<button onclick="$('#pippo').empty()">svuota</button>


<div style="width: 1000px;height: 800px; overflow: auto;position: absolute;top:30px;left:50px; border: 1px solid black;">
<div id="d" style="width: 1500px;height: 800px; background-color: white;"></div>
</div>

<script>

$(function () {


  $("#d").svg({settings:{id:"pippo"},onLoad:function (svg) {

    //define gradient
    var defs = svg.defs('myDefs');
    svg.linearGradient(defs, 'taskGrad',[[0, '#ddd'],[.5, '#fff'],[1, '#ddd']], 0, 0, 0,"100%");



    var r1 = $(svg.rect(100, 200, 200, 100)).attr("id", "r1");
    var r2 = $(svg.rect(300, 350, 200, 100)).attr("id", "r2");
    var r3 = $(svg.rect(400, 50, 300, 100)).attr("id", "r3");

    var p = svg.createPath().move(0, 0);
    var path2 = $(svg.path(p, {fill:'none', stroke:'#D90000', strokeWidth:2}));
    var path3 = $(svg.path(p, {fill:'none', stroke:'#D90000', strokeWidth:2}));

    r2.data("path", path2)
    r3.data("path", path3)



    updateLink(svg, path2, r1, r2)
    updateLink(svg, path3, r1, r3)

    //var task = $.JST.createFromTemplate({id:1, hasExternalDep:false, progress:30, startIsMilestone:false, endIsMilestone:false}, "TASKBAR");

    var tskSvg = _createTaskSVG (svg,{id:1, hasExternalDep:false, progress:50, startIsMilestone:false, endIsMilestone:false,name:"Task name",hasChild:true,status:"STATUS_ACTIVE"},{x:300,y:500,width:200})
    $(tskSvg).dragExtedSVG({drop:function(){console.debug("task dropped") },stopResize:function(){console.debug("task resized") }});

    var cb=function(){
      updateLink(svg, $("#r2").data("path"), $("#r1"), $("#r2"));
      updateLink(svg, $("#r3").data("path"), $("#r1"), $("#r3"));
    };
    r1.dragExtedSVG({resize:cb,drag:cb});

    r2.dragExtedSVG({canDrag:true,canResize:false,drop:function(){console.debug("r2 dropped") },stopResize:function(){console.debug("r2 resized") }})
    r3.dragExtedSVG({canDrag:true,canResize:true,resizeZoneWidth:50,drop:function(){console.debug("r3 dropped") },stopResize:function(){console.debug("r3 resized") }})

    $("svg").css("position","relative");
  }});


  console.debug($("svg").find("rect:not([x])"))
});


function _createTaskSVG(svg,task,dimensions){
  var taskSvg = svg.svg(dimensions.x,dimensions.y, dimensions.width,25,{class:"taskBoxSVG",taskid:task.id});

  //external box
  var layout=svg.rect(taskSvg,0,0,"100%","100%",{class:"taskLayout", rx:"6",ry:"6"});

  //status
  svg.rect(taskSvg,6,6,13,13,{stroke:1,rx:"2", ry:"2",status:task.status,class:"taskStatusSVG"} );

  //progress
  if (task.progress>0){
    var progress=svg.rect(taskSvg,0,0,(task.progress>100?100:task.progress)+"%","100%",{fill:(task.progress>100?"red":"rgb(153,255,51)"),rx:"6",ry:"6",opacity:.4});
    svg.text(taskSvg, (task.progress>90?90:task.progress)+"%",18,task.progress+"%",{stroke:"#888","font-size":"12px"});
  }
  if (task.hasChild)
    svg.rect(taskSvg,0,0,"100%",3,{fill:"#000"});

  if (task.startIsMilestone){
    svg.image(taskSvg,-9,4,18,18,"milestone.png")
  }

  if (task.endIsMilestone){
    svg.image(taskSvg,"100%",4,18,18,"milestone.png",{transform:"translate(-9)"})
  }

  return taskSvg

}


function updateLink(svg, path, r1, r2) {
  ps = 10;
  cps = 100;


  var fx1 = parseFloat(r1.attr("x"));
  var fx2 = fx1 + parseFloat(r1.attr("width"));
  var fy = parseFloat(r1.attr("y")) + parseFloat(r1.attr("height")) / 2;

  var tx1 = parseFloat(r2.attr("x"));
  var tx2 = tx1 + parseFloat(r2.attr("width"));
  var ty = parseFloat(r2.attr("y")) + parseFloat(r2.attr("height")) / 2;

  //console.debug(fx1,fx2,fy,tx1,tx2,ty)

  var p = svg.createPath();
  //p.move(fx2,fy).line(ps,0,true).curveC(fx2+ps+cps,fy,tx1-ps-cps,ty,tx1-ps,ty).line(ps,0,true);


  var tooClose = tx1 < fx2 + 2 * ps;
  var r = 10; //radius
  var arrowOffset = 5;
  var up = fy > ty;
  var fup = up ? -1 : 1;

  var prev = fx2 + 2 * ps > tx1;
  var fprev = prev ? -1 : 1;

  if (tooClose) {
    var firstLine = fup * ( parseFloat(r1.attr("height")) / 2 - 2 * r + 2);
    p.move(fx2, fy)
            .line(ps, 0, true)
            .arc(r, r, 90, false, !up, r, fup * r, true)
            .line(0, firstLine, true)
            .arc(r, r, 90, false, !up, -r, fup * r, true)
            .line(fprev * 2 * ps + (tx1 - fx2), 0, true)
            .arc(r, r, 90, false, up, -r, fup * r, true)
            .line(0, (Math.abs(ty - fy) - 4 * r - Math.abs(firstLine)) * fup - arrowOffset, true)
            .arc(r, r, 90, false, up, r, fup * r, true)
            .line(ps, 0, true)


  } else {
    p.move(fx2, fy)
            .line((tx1 - fx2) / 2 - r, 0, true)
            .arc(r, r, 90, false, !up, r, fup * r, true)
            .line(0, ty - fy - fup * 2 * r + arrowOffset, true)
            .arc(r, r, 90, false, up, r, fup * r, true)
            .line((tx1 - fx2) / 2 - r, 0, true)

  }
  path.attr("d", p.path())
}

</script>

</body>

</html>
